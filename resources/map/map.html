<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>DroneMapper - Interactive Map</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/@mapbox/mapbox-gl-draw@1.4.3/dist/mapbox-gl-draw.css" type="text/css" />
    <script src="qrc:///qtwebchannel/qwebchannel.js"></script>
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }

        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 10px;
            z-index: 1000;
        }

        .control-button {
            background: #0078d4;
            color: white;
            border: none;
            padding: 8px 16px;
            margin: 4px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }

        .control-button:hover {
            background: #106ebe;
        }

        .control-button.active {
            background: #005a9e;
        }

        .info-panel {
            position: absolute;
            top: 10px;
            right: 10px;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
            padding: 15px;
            max-width: 300px;
            z-index: 1000;
            font-family: Arial, sans-serif;
            font-size: 12px;
        }

        .info-panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #333;
        }

        .info-item {
            margin: 5px 0;
            color: #666;
        }

        .info-value {
            font-weight: bold;
            color: #0078d4;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="map-controls">
        <button id="btn-polygon" class="control-button">Draw Polygon</button>
        <button id="btn-rectangle" class="control-button">Draw Rectangle</button>
        <button id="btn-circle" class="control-button">Draw Circle</button>
        <button id="btn-waypoint" class="control-button">Add Waypoint</button>
        <button id="btn-clear" class="control-button">Clear All</button>
        <button id="btn-generate" class="control-button" style="background: #28a745;">Generate Flight Plan</button>
    </div>

    <div class="info-panel" id="info-panel" style="display: none;">
        <h3>Flight Plan Info</h3>
        <div class="info-item">Area: <span class="info-value" id="info-area">-</span></div>
        <div class="info-item">Perimeter: <span class="info-value" id="info-perimeter">-</span></div>
        <div class="info-item">Waypoints: <span class="info-value" id="info-waypoints">0</span></div>
        <div class="info-item">Distance: <span class="info-value" id="info-distance">-</span></div>
        <div class="info-item">Est. Time: <span class="info-value" id="info-time">-</span></div>
        <div class="info-item">Photos: <span class="info-value" id="info-photos">-</span></div>
    </div>

    <script>
        // Initialize MapLibre GL
        const map = new maplibregl.Map({
            container: 'map',
            style: {
                version: 8,
                sources: {
                    'osm': {
                        type: 'raster',
                        tiles: [
                            'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
                            'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
                        ],
                        tileSize: 256,
                        attribution: '&copy; OpenStreetMap Contributors'
                    },
                    'satellite': {
                        type: 'raster',
                        tiles: [
                            'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'
                        ],
                        tileSize: 256,
                        attribution: 'Esri, Maxar, Earthstar Geographics'
                    }
                },
                layers: [{
                    id: 'satellite-layer',
                    type: 'raster',
                    source: 'satellite',
                    minzoom: 0,
                    maxzoom: 22
                }],
                glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
            },
            center: [-122.4194, 37.7749], // San Francisco default
            zoom: 14,
            pitch: 0,
            bearing: 0
        });

        // Add navigation controls
        map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
        map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

        // Drawing tools
        const draw = new MapboxDraw({
            displayControlsDefault: false,
            controls: {},
            defaultMode: 'simple_select'
        });
        map.addControl(draw);

        // State management
        let currentMode = null;
        let flightPathLayer = null;
        let qtBridge = null;

        // Initialize Qt WebChannel
        new QWebChannel(qt.webChannelTransport, function(channel) {
            qtBridge = channel.objects.mapBridge;
            console.log('Qt WebChannel initialized');

            // Notify Qt that map is ready
            if (qtBridge && qtBridge.onMapReady) {
                qtBridge.onMapReady();
            }
        });

        // Map loaded event
        map.on('load', function() {
            console.log('Map loaded');

            // Add sources for flight path
            map.addSource('flight-path', {
                type: 'geojson',
                data: {
                    type: 'FeatureCollection',
                    features: []
                }
            });

            // Add flight path line layer
            map.addLayer({
                id: 'flight-path-line',
                type: 'line',
                source: 'flight-path',
                paint: {
                    'line-color': '#ff0000',
                    'line-width': 3,
                    'line-opacity': 0.8
                }
            });

            // Add waypoint markers layer
            map.addLayer({
                id: 'flight-path-points',
                type: 'circle',
                source: 'flight-path',
                paint: {
                    'circle-radius': 6,
                    'circle-color': '#ff0000',
                    'circle-stroke-color': '#ffffff',
                    'circle-stroke-width': 2
                },
                filter: ['==', '$type', 'Point']
            });

            // Add waypoint labels
            map.addLayer({
                id: 'flight-path-labels',
                type: 'symbol',
                source: 'flight-path',
                layout: {
                    'text-field': ['get', 'number'],
                    'text-size': 12,
                    'text-offset': [0, -1.5]
                },
                paint: {
                    'text-color': '#ffffff',
                    'text-halo-color': '#000000',
                    'text-halo-width': 2
                },
                filter: ['==', '$type', 'Point']
            });
        });

        // Drawing event handlers
        map.on('draw.create', updateArea);
        map.on('draw.delete', updateArea);
        map.on('draw.update', updateArea);

        function updateArea(e) {
            const data = draw.getAll();
            if (data.features.length > 0) {
                const feature = data.features[0];

                // Calculate area for polygons
                if (feature.geometry.type === 'Polygon') {
                    const area = turf.area(feature);
                    const rounded_area = Math.round(area * 100) / 100;

                    document.getElementById('info-area').textContent =
                        rounded_area.toLocaleString() + ' mÂ²';
                    document.getElementById('info-panel').style.display = 'block';

                    // Send to Qt
                    if (qtBridge && qtBridge.onAreaDrawn) {
                        qtBridge.onAreaDrawn(JSON.stringify(feature.geometry));
                    }
                }
            } else {
                document.getElementById('info-panel').style.display = 'none';
            }
        }

        // Button event handlers
        document.getElementById('btn-polygon').addEventListener('click', function() {
            draw.changeMode('draw_polygon');
            setActiveButton('btn-polygon');
        });

        document.getElementById('btn-rectangle').addEventListener('click', function() {
            // Custom rectangle mode (simplified)
            draw.changeMode('draw_polygon');
            setActiveButton('btn-rectangle');
        });

        document.getElementById('btn-circle').addEventListener('click', function() {
            // Circle drawing will be custom implemented
            draw.changeMode('simple_select');
            setActiveButton('btn-circle');
            alert('Click on map to place circle center, then drag to set radius');
        });

        document.getElementById('btn-waypoint').addEventListener('click', function() {
            draw.changeMode('draw_point');
            setActiveButton('btn-waypoint');
        });

        document.getElementById('btn-clear').addEventListener('click', function() {
            draw.deleteAll();
            clearFlightPath();
            document.getElementById('info-panel').style.display = 'none';
            setActiveButton(null);
        });

        document.getElementById('btn-generate').addEventListener('click', function() {
            const data = draw.getAll();
            if (data.features.length > 0 && qtBridge && qtBridge.onGenerateFlightPlan) {
                qtBridge.onGenerateFlightPlan(JSON.stringify(data));
            } else {
                alert('Please draw a survey area first!');
            }
        });

        function setActiveButton(buttonId) {
            document.querySelectorAll('.control-button').forEach(btn => {
                btn.classList.remove('active');
            });
            if (buttonId) {
                document.getElementById(buttonId).classList.add('active');
            }
        }

        function clearFlightPath() {
            if (map.getSource('flight-path')) {
                map.getSource('flight-path').setData({
                    type: 'FeatureCollection',
                    features: []
                });
            }
        }

        // Public API for Qt to call
        window.setCenter = function(lng, lat, zoom) {
            map.flyTo({
                center: [lng, lat],
                zoom: zoom || map.getZoom(),
                essential: true
            });
        };

        window.displayFlightPath = function(geojsonString) {
            const geojson = JSON.parse(geojsonString);
            if (map.getSource('flight-path')) {
                map.getSource('flight-path').setData(geojson);
            }

            // Update info panel
            if (geojson.features && geojson.features.length > 0) {
                const points = geojson.features.filter(f => f.geometry.type === 'Point');
                document.getElementById('info-waypoints').textContent = points.length;
                document.getElementById('info-panel').style.display = 'block';
            }
        };

        window.updateFlightInfo = function(info) {
            const data = JSON.parse(info);
            if (data.distance) {
                document.getElementById('info-distance').textContent =
                    (data.distance / 1000).toFixed(2) + ' km';
            }
            if (data.time) {
                document.getElementById('info-time').textContent =
                    Math.ceil(data.time / 60) + ' min';
            }
            if (data.photos) {
                document.getElementById('info-photos').textContent = data.photos;
            }
        };

        window.switchBaseMap = function(type) {
            // Switch between satellite and street view
            const layers = map.getStyle().layers;
            if (type === 'satellite') {
                // Show satellite
                if (!map.getLayer('satellite-layer')) {
                    map.addLayer({
                        id: 'satellite-layer',
                        type: 'raster',
                        source: 'satellite',
                        minzoom: 0,
                        maxzoom: 22
                    }, 'flight-path-line');
                }
            } else {
                // Show street
                if (map.getLayer('satellite-layer')) {
                    map.removeLayer('satellite-layer');
                }
                map.addLayer({
                    id: 'osm-layer',
                    type: 'raster',
                    source: 'osm',
                    minzoom: 0,
                    maxzoom: 22
                }, 'flight-path-line');
            }
        };

        // Turf.js for area calculations (inline minimal version)
        const turf = {
            area: function(feature) {
                const coords = feature.geometry.coordinates[0];
                let area = 0;
                for (let i = 0; i < coords.length - 1; i++) {
                    const p1 = coords[i];
                    const p2 = coords[i + 1];
                    area += this.deg2rad(p2[0] - p1[0]) * (2 + Math.sin(this.deg2rad(p1[1])) + Math.sin(this.deg2rad(p2[1])));
                }
                area = Math.abs(area * 6378137 * 6378137 / 2);
                return area;
            },
            deg2rad: function(deg) {
                return deg * Math.PI / 180;
            }
        };

        console.log('Map interface initialized');
    </script>
</body>
</html>
